\section{Methodology \& Implementation}\label{sec:meths}

\subsection{Harmonization Methods}

IAM emission results are provided along temporal (normally half decade or
decade), spatial (i.e., model regions), gas species, and sectoral
dimensions. Each individual temporal trajectory, i.e., unique combinations of
regions ($r$), species ($g$), and sectors ($s$), must be harmonized to the
initial modeling period. Given a model trajectory, $m_{r, g, s}(t)$, historical
values, $h_{r, g, s}(t)$, and model base year, $t_i$, a harmonized trajectory
needs to be calculated. The \textit{harmonization quality} of a trajectory,
i.e., how well a given harmonization algorithm performs, depends on a number of
factors. Of chief import is the faithful representation of the original,
unharmonized, trajectory as well as the representation of negative trajectories
(i.e., if a trajectory becomes negative, both the timing and total magnitude
should be as close as possible) which are of critical importance for cumulative
\cotwo calculations.

In previous studies \cite{meinshausen_rcp_2011,rogelj_discrepancies_2011}, two
\textit{families} of methods have been used: those that operate on the ratio of
base year values (i.e., $\frac{h(t_i)}{m(t_i)}$) and those that operate on the
offset of base year values (i.e., $h(t_i) - m(t_i)$). A number of the classic
methods are implemented in \code{aneris} including ratio-convergence shown in
Equation \ref{eqs:ratio}, offset-convergence shown in Equation \ref{eqs:offset},
and interpolation shown in Equation \ref{eqs:interpolate}. The convergence
factor, $\beta$, scales linearly from 1 to 0 over $[t_i, t_f)$ and is shown in
  Equation \ref{eqs:factor}. In all equations the region, species, and sector
  indices have been dropped for clarity. Each equation is a function of time,
  model trajectory, historical trajectory, base year ($t_i$), and a convergence
  year ($t_f$), at which point the harmonized trajectory converges to the
  unharmonized trajectory. \codeb{aneris} provides a number of methods to choose
  from for each of the harmonization families. A summary of all available
  methods is provided in Table \ref{tab:meths}.


\begin{equation}\label{eqs:factor}
  \beta(t, t_i, t_f) =
  \begin{cases}
    1 - \frac{t - t_i}{t_f - t_i},& \text{if } t < t_f\\
    0,                        & \text{otherwise}
  \end{cases}
\end{equation}

\begin{equation}\label{eqs:ratio}
  m^{rat}(t, m, h, t_i, t_f) = [\beta(t, t_i, t_f) (\frac{h(t_i)}{m(t_i)} - 1) + 1] m(t)
\end{equation}

\begin{equation}\label{eqs:offset}
  m^{off}(t, m, h, t_i, t_f) = \beta(t, t_i, t_f) (h(t_i) - m(t_i)) + m(t)
\end{equation}
  
\begin{equation}\label{eqs:interpolate}
  m^{int}(t, m, h, t_i, t_f) =
  \begin{cases}
    \beta(t, t_i, t_f) (h(t_i) - m(t_f)) + m(t_f), & \text{if } t < t_f\\
    m(t), & \text{otherwise}
  \end{cases}
\end{equation}


\begin{table}[h!]
\centering
\caption{All Harmonization Methods Provided in \code{aneris}}
\label{tab:meths}
\begin{tabular}{|l|l|l|}
\hline
Method Name                             & Harmonization Family & Convergence Year\\
\hline
\code{constant\_ratio}                  & ratio              & $t_f = \infty$\\
\code{reduce\_ratio\_<year>}            & ratio              & $t_f = $\code{<year>}\\
\code{constant\_offset}                 & offset             & $t_f = \infty$\\
\code{reduce\_offset\_<year>}           & offset             & $t_f = $\code{<year>}\\
\code{linear\_interpolate\_<year>}      & interpolation      & $t_f = $\code{<year>}\\
\hline
\end{tabular}
\end{table}

\subsection{Default Method Decision Tree}\label{sec:tree}

A \textit{decision tree} approach has been implemented in \codeb{aneris} which
provides a systematic and documented decision-making process to determine the
preferred harmonization algorithm. In order to provide reasonable
\textit{default} methods, the historical trajectory, unharmonized model
trajectory, and relative difference between history and model values in the
harmonization year are analyzed. The decision tree used in this analysis is a
result of collaborative efforts between IAM teams and is shown graphically in
Figure \ref{fig:decision_tree}.


\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{decision_tree.pdf}
    \caption[]{
      \label{fig:decision_tree}
      The default method decision tree used in the \code{aneris} software
      library. For all decisions, upper (purple) branches represent a ``yes''
      response and lower (orange) branches represent a ``no'' response. The
      coefficient of variation, $c_v$, is defined in Equation \ref{eqs:cov},
      $dH$ is defined as $\left|\frac{h(t_i) - m(t_i)}{h(t_i)}\right|$, and
      decision-making thresholds for $c_v$ and $dH$ are described below. Methods
      labeled in \textit{green} are likely to closely match unharmonized
      results, methods in \textit{yellow} will likely somewhat match
      unharmonized results, and methods in \textit{red} can be expected to have
      a large relative difference between harmonized and unharmonized results.}
  \end{center}
\end{figure}

A number of characteristics impact the decision of which default method to
select based on the effect of the characteristic on the potential harmonized
trajectory. For example, it is possible for models to report zero values in the
harmonization year in situations in which technologies are introduced in future
time periods in regions or for sectors which produce an emissions species that
is absent in the initial modeling period. In such cases, an offset method is
required as a ratio method would mask future emissions and erroneously harmonize
the trajectory. 

In most cases, however, models do report values in the harmonization
year. Figure \ref{fig:cases} displays a number of example trajectories which
highlight the possible issues resulting from harmonizing model results in
different contexts. When model and historical values are relatively close, a
convergence method is chosen in order to be as representative as possible to the
underlying unharmonized model results (Figure \ref{fig:cases}, Panel
\code{a}). If values are not close, the constant ratio method is chosen in order
to provide reasonable trajectories that still incorporate modeled effects
(Figure \ref{fig:cases}, Panel \code{b}). 

Models can additionally report negative emissions in certain contexts which must
be taken into account during harmonization. Such a case is possible for gas
species which can be extracted from the environment and stored, as is the case
for \cotwo in future scenarios with climate mitigation. If a model provides a
trajectory that transitions from positive to negative emissions and base year
results are similar, then a convergence method is used in order to guarantee
capture of this transition in a representative fashion (Figure \ref{fig:cases},
Panel \code{c}). If the discrepancy in base year results is large, it is
possible for a negative trajectory to be inappropriately harmonized to a
positive, but decreasing, trajectory. As such, the constant ratio method is
chosen (Figure \ref{fig:cases}, Panel \code{d}).

\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{cases.pdf}
    \caption[]{
      \label{fig:cases}
      The effect of different harmonization routines on model trajectories under
      ``normal'' circumstances (Panel \code{a}), when there is a large
      difference between historical and model values in the harmonization year
      (Panels \code{b} and \code{d}), and when model trajectories result in
      negative emissions by the end of the modeling time horizon (Panels
      \code{c} and \code{d}). Identical model trajectories are used in each row
      (Panels \code{a}, \code{b}; \code{c}, \code{d}). In each column,
      historical values are increased in the base year by an order of magnitude
      (from 10 to 100). In each Panel, a subset of the potential routines
      provide a better harmonization quality than others as described in the
      text.
    }
  \end{center}
\end{figure}

Temporal variability of the historical trajectory is also an important
characteristic when considering the choice of harmonization method.  Emissions
from forest and grassland fires, for example, vary from year to year due to a
combination of meteorological conditions and anthropogenic drivers. Land use
emissions in many IAMs are modeled using average emission factors and do not
capture conditions in a specific year. A longer convergence horizon is thus
desired in order to incorporate highly variable historical data with modeled
results as is consistency in harmonization method because the effects are
modeled similarly across regions and species. In order to detect emissions with
a high amount of variation, a measure of the coefficient of variation, $c_v$, of
the first derivative of the historical trajectory is calculated using the
standard deviation, $\sigma$, and the mean, $\mu$, as shown in Equation
\ref{eqs:cov}.

The value of $c_v$ is then tested against a threshold, $\tau_{c_v}$. To
determine this threshold, an analysis of the recent CEDS and LUC historical data
has been performed. Figure \ref{fig:cov} shows the distribution of LUC $c_v$s
and non-LUC $c_v$s as determined for historical data aggregated to the model
regions of 5 different IAMs involved in the SSP process. A threshold value of
$\tau_{c_v} = 20$ has been chosen based on these observations as it
optimally divides the two distributions. Importantly, tails of the LUC and
non-LUC overlap, thus there are both false positives (~7\% of non-LUC
trajectories) and false negatives (~10\% of LUC trajectories). However, as any
regional definition is model dependent and thus any regional aggregation is
possible an automated detection mechanism is necessary.

\begin{equation}\label{eqs:cov}
    c_v =  \frac{\sigma(h^{\prime}(t))}{\mu(h^{\prime}(t))}
\end{equation}


\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{cov.pdf}
    \caption[]{
      \label{fig:cov}
      The distribution of $c_v$ values for LUC and non-LUC historical
      trajectories is shown. CEDS historical data \cite{hoesly_historical_2017}
      is used for non-LUC data and \cite{van_marle_historic_2017} is used for
      LUC data. All historical data has been aggregated from countries to IAM
      model regional definitions, and all gas species included in the historical
      data sets are included in the analysis. The solid black line indicates the
      threshold value, $\tau_{c_v}$, used by default in \code{aneris}.  }
  \end{center}
\end{figure}

Finally, consideration is taken with respect to the relative difference between
the historic and model values in the harmonization time period. In order to
investigate the possible values that these relative differences can take, the
IAM values used in the SSP and (ongoing) CMIP6 inter-comparison
exercises are used. A distribution of these differences for all models in the
study is presented in Figure \ref{fig:dh}. Given the available data, a threshold
value of $\tau_{dH} = 50$\% was chosen to be used as a default in \code{aneris}.

\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{dh.pdf}
    \caption[]{
      \label{fig:dh}
      The distribution of relative differences between model and historical
      values in the harmonization year is shown. The solid black line indicates
      the 50\% threshold value, $\tau_{dH}$, used by default in \code{aneris}.
    }
  \end{center}
\end{figure}

\subsection{\code{aneris} Workflow}\label{sec:workflow}

The full \code{aneris} workflow is comprised of a number of components shown
graphically in Figure \ref{fig:workflow}. Unharmonized model data and a
run-control configuration are read in via an Excel spreadsheet. Data is assumed
to be in the IAMC format, i.e., using \code{Model}, \code{Scenario},
\code{Region}, \code{Variable}, and \code{Unit} columns in addition to columns
representing each modeled time period.

Users are able to control the harmonization process via a number of options. The
primary mechanism by which users control the process is by providing
\textit{override} methods for any combination of region and variable (i.e.,
sector and gas species).  In practice, it may be possible that not all default
methods chosen will provide robust harmonized trajectories, especially if there
is a significant difference between historical and model values in the
harmonization year, if there is significant upward or downward movement in the
model trajectory, or if there are known discrepancies in sectoral definition
between the IAM and historical data source. In such cases, override methods can
ameliorate the issues associated with the default method choice. In order to
help identify these cases, harmonization \textit{diagnostics} are provided which
analyze the relative difference between harmonized and unharmonized trajectories
at their mid (if $> 400$\%) and end-points (if $> 200$\%). If override methods
are provided, they are used instead of the default methods as determined by the
default method decision tree. Furthermore, users can set the above-mentioned
thresholds as well as the LUC method used in the decision tree (see Figure
\ref{fig:decision_tree}). Further detail of input parameters can be found
\href{http://mattgidden.com/aneris/config.html}{online}.

\begin{figure}
  \begin{center}
    \includegraphics[height=0.9\textheight]{aneris-workflow.pdf}
    \caption[]{
      \label{fig:workflow}
      The full harmonization process as executed by \code{aneris}. Operations
      that can be configured with user-based input configurations are shown in
      purple. The core harmonization process is shown in yellow.  }
  \end{center}
\end{figure}

Input data then undergoes a cleaning operation, which adds (null) model
trajectories that exist in the historical data set but are not provided by the
model input and detects any issues that would cause the harmonization process to
fail. The methods used to harmonize the data are then determined and the
harmonization process is executed. Upon completion of the harmonization process,
aggregation of common analysis regions is performed. A common regional
aggregation used in the IAM community was defined in the Representative
Concentration Pathways (RCPs) \cite{vuuren_representative_2011}, shown in Figure
\ref{fig:regions}. Finally, any exogenous trajectories the user provides are
added. Exogenous trajectories are normally provided for unmodeled gases with
well-accepted scenario trajectories, e.g., chlorofluorocarbons provided by WMO
\cite{wmo2014}. Upon completion, the harmonized trajectories and meta data
regarding the harmonization process are returned. A description of all returned
meta data is provided in Table \ref{tab:metadata}.


\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{MESSAGE_11-5regions_map.pdf}
    \caption[]{
      \label{fig:regions}
      The 5 regions used in the RCPs with their 11-region constituents: Asia
      (Central Asia, South Asia, Pacific Asia) [yellows], Latin America
      [magenta], the Middle East and Africa [greens], the OECD (North America,
      Western Europe, and Pacific OECD) [blues], and the Reforming Economies
      (Eastern Europe and Former Soviet Union) [reds].  }
  \end{center}
\end{figure}


\begin{table}[]
\centering
\caption{Meta data provided by the \code{aneris} harmonization routine. This meta data is provided for every combination of region, sector, and emissions species.}
\label{tab:metadata}
\begin{tabular}{|p{2cm}|p{8cm}|}
\hline
\textbf{Column}       & \textbf{Description}                                      \\
\hline
\hline
method       & The harmonization method used.                                               \\
\hline
default      & The default harmonization method as determined by the default decision tree. \\
\hline
override     & The method provided as an override (if any).                                 \\
\hline
offset       & The offset value between history and model in the harmonization year.        \\
\hline
ratio        & The ratio value between history and model in the harmonization year.         \\
\hline
cov          & The coefficient of variation value of the historical trajectory.                           \\
\hline
unharmonized & The unharmonized value in the harmonization year.                            \\
\hline
history      & The historical value in the harmonization year.                             \\
\hline
harmonized   & The resulting harmonized value in the harmonization year.\\
\hline
\end{tabular}
\end{table}
