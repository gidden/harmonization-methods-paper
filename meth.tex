\section{Methodology \& Implementation}\label{sec:meths}

\subsection{Harmonization Methods}

IAM emission results are provided along temporal (normally half decade or
decade), spatial (i.e., model regions), gas species, and sectoral
dimensions. Each individual temporal trajectory, i.e., unique combinations of
regions ($r$), species ($g$), and sectors ($s$), must be harmonized to the
initial time step. Given a model trajectory, $m_{r, g, s}(t)$, historical
trajectory, $h_{r, g, s}(t)$, and initial time step $t_i$, a harmonized
trajectory can be calculated. The ``goodness of fit'' of a trajectory depends on
a number of factors, most notably the faithful representation of the original,
unharmonized, trajectory. However, other important factors must be considered,
such as the representation of negative trajectories (i.e., if a trajectory
becomes negative, both the timing and total magnitude should be as close as
possible) which are of critical importance for cumulative CO2 calculations.

In previous studies \cite{meinshausen_rcp_2011,rogelj_discrepancies_2011}, two
\textit{families} of methods have been used: those that operate on the ratio of
base year values (i.e., $\frac{h(t_i)}{m(t_i)}$) and those that operate on the
offset of base year values (i.e., $h(t_i) - m(t_i)$). The \code{aneris} code
base provides a number of variations on the classic methods, including
ratio-convergence methods shown in Equation \ref{eqs:ratio}, offset-convergence
methods shown in Equation \ref{eqs:offset}, and interpolation methods shown in
Equation \ref{eqs:interpolate}; the convergence factor, $\beta$, for associated
methods is shown first in Equation \ref{eqs:factor}. Note that region, species,
and sector indices have been dropped for clarity. Each equation is a function of
time, model trajectory, historical trajectory, harmonization time step, and a
convergence time step ($t_f$), at which point the harmonized trajectory
converges to the unharmonized trajectory. The \code{aneris} code base provides a
number of methods to choose from for each of the harmonization families. A
summary of all available methods is provided in Table \ref{tab:meths}.


\begin{equation}\label{eqs:factor}
  \beta(t, t_i, t_f) =
  \begin{cases}
    1 - \frac{t - t_i}{t_f - t_i},& \text{if } t \leq t_f\\
    0,                        & \text{otherwise}
  \end{cases}
\end{equation}

\begin{equation}\label{eqs:ratio}
  m^{rat}(t, m, h, t_i, t_f) = [\beta(t, t_i, t_f) (\frac{h(t_i)}{m(t_i)} - 1) + 1] m(t)
\end{equation}

\begin{equation}\label{eqs:offset}
  m^{off}(t, m, h, t_i, t_f) = \beta(t, t_i, t_f) (h(t_i) - m(t_i)) + m(t)
\end{equation}
  
\begin{equation}\label{eqs:interpolate}
  m^{int}(t, m, h, t_i, t_f) =
  \begin{cases}
    \frac{m(t_f) - h(t_i)}{t_f - t_i}(t - t_i) + h(t_i), & \text{if } t \leq t_f\\
    m(t), & \text{otherwise}
  \end{cases}
\end{equation}


\begin{table}[]
\centering
\caption{All Harmonization Methods Provided in \code{aneris}}
\label{tab:meths}
\begin{tabular}{|l|l|l|}
\hline
Method Name                             & Harmonization Family & Convergence Year\\
\hline
\code{constant\_ratio}                  & ratio              & $t_f = \infty$\\
\code{reduce\_ratio\_<year>}            & ratio              & $t_f = $\code{<year>}\\
\code{constant\_offset}                 & offset             & $t_f = \infty$\\
\code{reduce\_offset\_<year>}           & offset             & $t_f = $\code{<year>}\\
\code{linear\_interpolate\_<year>}      & interpolation      & $t_f = $\code{<year>}\\
\hline
\end{tabular}
\end{table}

\subsection{Default Method Decision Tree}\label{sec:tree}

While historically expert opinion has guided the choice of harmonization methods
for a given trajectory, a new, \textit{decision tree} approach has been
implemented in this work which provides a systematic and documented
decision-making process for method determination. In order to provide reasonable
\textit{default} methods, the historical trajectory, unharmonized model
trajectory, and relative difference between history and model values in the
harmonization year are analyzed. The decision tree used in this analysis is
shown graphically in Figure \ref{fig:decision_tree}.


\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{decision_tree.png}
    \caption[]{
      \label{fig:decision_tree}
      The default method decision tree used in the \code{aneris} software
      library. For all decisions, upper branches represent a ``yes'' response
      and lower branches represent a ``no'' response. $dH$ is defined as
      $\left|\frac{h(t_i) - m(t_i)}{h(t_i)}\right|$, and decision-making
      thresholds are described below. Finally, default choices in \textit{green}
      label methods that will likely closely match unharmonized results, choices
      in \textit{yellow} will likely somewhat match unharmonized results, and
      choices in \textit{red} can be expected to have a large relative
      difference between harmonized and unharmonized results.}
  \end{center}
\end{figure}

A number of characteristics impact the decision of which default method to
select based on the effect of the characteristic on the potential harmonized
trajectory. For example, it is possible for models to report zero values in the
harmonization year in situations in which technologies are introduced in future
time periods in regions or for sectors which produce an emissions species that
is absent in the initial modeling period. In such cases, an offset method is
required as a ratio method would mask future emissions and erroneously harmonize
the trajectory. In most cases, however, models do report values in the
harmonization year. When model and historical values are relatively close, a
convergence method is chosen in order to be as representative as possible to the
underlying unharmonized model results. The final model-based characteristic of
import is whether the model reports negative emissions. Such a case is possible
for gas species which can be extracted from the environment and stored, as is
the case for CO2 in future scenarios with climate mitigation. If a model
% * <sfujimori112256@gmail.com> 2017-06-07T10:07:21.265Z:
% 
% > with climate mitigation
% Not necessarily high mitigation. Land use can be negative even in baseline.
% 
% ^.
provides a trajectory that transitions from positive to negative emissions, then
a convergence method is used in order to guarantee capture of this
transition. Otherwise, it is possible, given the relative values between history
and model in the harmonization year, for a negative trajectory to be
inappropriately harmonized to a positive, but decreasing, trajectory.

Variability of the historical trajectory is also an important characteristic
when considering the choice of harmonization method. Such trajectories are
normally indicative of emissions from land use sectors. Land use sectors are
modeled with varying fidelity by IAMs, but in general proxies are used for
emissions trajectories. Take for example emissions from grassland burning: for
most models, the use of grass and paturelands is endogenously modeled, and
emissions from the burning of these lands is determined by applying an emissions
factor; in general, the more grassland usage that occurs in a scenario, the
higher the emissions from the burning thereof. Therefore, consistency in
harmonization method is important because the effects are modeled similarly
across regions and species. In order to reliably detect land-use-like emissions,
a measure of the coefficient of variation of the first derivative of the
historical trajectory, $c_v$, is calculated as shown in Equation \ref{eqs:cov},
where $\sigma$ is the standard deviation, and $\mu$ is the mean of the
trajectory.

The value of $c_v$ is then tested against a threshold. To determine this
threshold, an analysis of the recent CEDS and LUC historical data has been
performed. Figure \ref{fig:cov} shows the distribution of LUC $c_v$s and non-LUC
$c_v$s as determined for historical data aggregated to the model regions of 5
different flagship IAMs. A threshold value of 20 has been chosen based on these
observations as it optimally divides the two distributions. Importantly, tails
of the LUC and non-LUC overlap, thus there are both false positives (~10\% of
non-LUC trajectories) and false negatives (~7\% of LUC trajectories). However,
as any regional definition is model dependent and thus any regional aggregation
is possible an automated detection mechanism is necessary.

\begin{equation}\label{eqs:cov}
    c_v =  \frac{\sigma(h^{\prime}(t))}{\mu(h^{\prime}(t))}
\end{equation}


\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{cov.pdf}
    \caption[]{
      \label{fig:cov}
      The distribution of $c_v$ values for LUC and non-LUC historical
      trajectories is shown. CEDS historical data \cite{hoesly_historical_2017}
      is used for non-LUC data and \cite{van_marle_historic_2017} is used for
      LUC data. All historical data has been aggregated from countries to IAM
      model regional definitions, and all gas species included in the historical
      datasets are included in the analysis. The solid black line indicates the
      threshold value used by default in \code{aneris}.  }
  \end{center}
\end{figure}

Finally, consideration is taken with respect to the relative difference between
the historic and model values in the harmonization time period. In order to
investigate the possible values that these relative differences can take, the
flagship IAMs values used in the SSP and (ongoing) CMIP6 inter-comparison
exercises are used. A distribution of these differences for all models in the
study is presented in Figure \ref{fig:dh}. Given the available data, a threshold
value of 50\% was chosen to be used as a default in \code{aneris}.

\begin{figure}
  \begin{center}
    \includegraphics[width=\textwidth]{dh.pdf}
    \caption[]{
      \label{fig:dh}
      The distribution of relative differences between model and historical
      values in the harmonization year is shown. The solid black line indicates
      the threshold value used by default in \code{aneris}.  
    }
  \end{center}
\end{figure}

\subsection{\code{aneris} Workflow}\ref{label:workflow}

The full \code{aneris} workflow is comprised of a number of components shown
graphically in Figure \ref{fig:workflow}. Unharmonized model data and a
run-control configuration are read in via an Excel spreadsheet. Data is assumed
to be in the \textit{IAM Consortium} format, i.e., using \code{Model},
\code{Scenario}, \code{Region}, \code{Variable}, and \code{Unit} columns in
addition to columns representing each modeled time period. 

Users are able to control the harmonization process via a number of options. The
primary mechanism by which users control the process is by providing
\textit{override} methods for any combination of region and variable (i.e.,
sector and gas species).  In practice, it may be possible that not all default
methods chosen will provide robust harmonized trajectories, especially if there
is a significant difference between historical and model values in the
harmonization year and there is significant upward or downward movement in the
model trajectory. In such cases, override methods can ameliorate the issues
associated with the default method choice. In order to help identify these
cases, harmonization \textit{diagnostics} are provided which analyze the relative
difference between harmonized and unharmonized trajectories at their mid and
end-points. If override methods are provided, they are used instead of the
default methods as determined by the default method decision tree. Furthermore,
users can set the above-mentioned thresholds as well as the LUC method used in
the decision tree (see Figure \ref{fig:decision_tree}). Further detail of input
parameters can be found \href{http://mattgidden.com/aneris/config.html}{online}.

\begin{figure}
  \begin{center}
    \includegraphics[height=0.85\textheight]{aneris-workflow.pdf}
    \caption[]{
      \label{fig:workflow}
      The full harmonization process as executed by \code{aneris}. Operations
      that can be configured with user-based input configurations are shown in
      purple. The core harmonization process is shown in yellow.  }
  \end{center}
\end{figure}

Input data then undergoes a cleaning operation, which adds (null) model
trajectories that exist in the historical dataset but are not provided by the
model input and detects any issues that would cause the harmonization process to
fail. The methods used to harmonize the data are then determined and the
harmonization process is executed. Upon completion of the harmonization process,
aggregation of common analysis regions is performed. A common regional
aggregation used in the IAM community is the RCP regional definition, as shown
in Figure \ref{fig:regions}. Finally, any exogenous trajectories the user provides
are added. Exogenous trajectories are normally provided for unmodeled gases with
well-accepted scenario trajectories, e.g., chlorofluorocarbons provided by WMO
\cite{wmo2014}. Upon completion, the harmonized trajectories and meta data
regarding the harmonization process are returned. A description of all returned
meta data is provided in Table \ref{tab:metadata}.


\begin{figure}
  \begin{center}
    \includegraphics[width=0.85\textwidth]{regions.png}
    \caption[]{
      \label{fig:regions}
      The 5 regions used in the RCPs with their 11-region constituents: Asia
      (Central Asia, South Asia, Pacific Asia), Latin Ameria, the Middle East
      and Africa, the OECD (North America, Western Europe, and Pacfic OECD),
      Reforming Economies (Eastern Europe and Former Soviet Union).
    }
  \end{center}
\end{figure}


\begin{table}[]
\centering
\caption{Meta data provided by the \code{aneris} harmonization routine. This meta data is provided for every combination of region, sector, and emissions species.}
\label{tab:metadata}
\begin{tabular}{|p{2cm}|p{8cm}|}
\hline
Column       & Description                                                                  \\
\hline
\hline
method       & The harmonization method used.                                               \\
\hline
default      & The default harmonization method as determined by the default decision tree. \\
\hline
override     & The method provided as an override (if any).                                 \\
\hline
offset       & The offset value between history and model in the harmonization year.        \\
\hline
ratio        & The ratio value between history and model in the harmonization year.         \\
\hline
cov          & The coefficient of variation value of the historical trajectory.                           \\
\hline
unharmonized & The unharmonized value in the harmonization year.                            \\
\hline
history      & This historical value in the harmonization year.                             \\
\hline
harmonized   & The resulting harmonized value in the harmonization year.\\
\hline
\end{tabular}
\end{table}
